<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Aii Neuro Pixel Stream Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://unpkg.com/@convai/experience-embed/dist/core/convai-embed.umd.js"></script>
    <style>
      :root {
        --page-pad: 16px;
        --gap: 12px;
      }

      * { box-sizing: border-box; }

      body {
        font-family: sans-serif;
        margin: 0;
        padding: var(--page-pad);
        background: #f0f0f0;
      }

      h1 {
        margin: 0 0 var(--gap) 0;
        font-size: 22px;
        line-height: 1.2;
      }

      /* Pixel stream area */
      #pixel-stream-container {
        background: #000;
        margin-bottom: var(--gap);
        position: relative;
        overflow: hidden;
        border-radius: 10px;
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
      }

      button {
        padding: 10px 14px;
        font-size: 15px;
        cursor: pointer;
        border: 0;
        border-radius: 10px;
        background: #ffffff;
      }

      button:hover {
        filter: brightness(0.97);
      }

      button:active {
        transform: translateY(1px);
      }
    </style>
  </head>
  <body>
    <h1>Aii Neuro Pixel Stream Demo</h1>

    <div id="pixel-stream-container"></div>

    <div class="controls">
      <button id="startBtn">Start Experience</button>
      <button id="enableCameraBtn">Enable Camera</button>
      <button id="disableCameraBtn">Disable Camera</button>
      <button id="enableAudioBtn">Enable Audio</button>
      <button id="disableAudioBtn">Disable Audio</button>
    </div>

    <script>
      const container = document.getElementById("pixel-stream-container");

      // ---- Dynamic resize (4:3) with NO-SCROLL guarantee ----
      // Goal: Make the stream as large as possible while ensuring
      // the header + controls remain visible on typical laptop screens.
      function resizeStream() {
        // Viewport space we must reserve:
        const pagePad = parseInt(getComputedStyle(document.body).paddingTop, 10) || 16;
        const headerEl = document.querySelector("h1");
        const controlsEl = document.querySelector(".controls");

        // Measure actual heights (best) with reasonable fallbacks
        const headerHeight = headerEl ? headerEl.offsetHeight : 60;
        const controlsHeight = controlsEl ? controlsEl.offsetHeight : 90;

        // Safety margins to prevent "almost fits" scrollbars
        const safety = 24; // extra breathing room
        const reservedVertical = (pagePad * 2) + headerHeight + controlsHeight + safety;

        // Max height available for the stream
        const maxStreamHeight = Math.max(180, window.innerHeight - reservedVertical);

        // Also cap by width so we don't exceed viewport width
        // width = height * (4/3)  => height = width * (3/4)
        const maxStreamWidth = Math.max(320, window.innerWidth - (pagePad * 2));
        const widthLimitedHeight = maxStreamWidth * 3 / 4;

        // Final height respects both vertical and horizontal constraints
        const height = Math.floor(Math.min(maxStreamHeight, widthLimitedHeight));

        // Derive width from height (4:3)
        const width = Math.floor(height * 4 / 3);

        container.style.height = height + "px";
        container.style.width = width + "px";
        container.style.marginLeft = "auto";
        container.style.marginRight = "auto";
      }

      // Resize on load and on viewport changes
      window.addEventListener("resize", resizeStream);
      window.addEventListener("orientationchange", resizeStream);
      resizeStream();

      // ---- Custom initial overlay ----
      const customInitialScreen = document.createElement("div");
      customInitialScreen.style.cssText = `
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        font-family: Arial, sans-serif;
      `;
      customInitialScreen.innerHTML = `
        <div style="text-align: center; padding: 16px;">
          <h2 style="margin: 0 0 8px 0;">Welcome to the Chat</h2>
          <p style="margin: 0; opacity: 0.9;">Click Start Experience to begin</p>
        </div>
      `;

      // ---- Pixel Stream client ----
      const pixelStream = new PixelStreamCore.PixelStreamClient({
        expId: "6e3faeaa-5289-4062-a448-df51df086b1d",
        container: container,
        InitialScreen: customInitialScreen,
      });

      window.pixelStream = pixelStream;

      // ---- Buttons ----
      document.getElementById("startBtn").addEventListener("click", () => {
        pixelStream.initializeExperience();
      });

      document.getElementById("enableCameraBtn").addEventListener("click", () => {
        pixelStream.enableCamera().catch(console.error);
      });

      document.getElementById("disableCameraBtn").addEventListener("click", () => {
        pixelStream.disableCamera().catch(console.error);
      });

      document.getElementById("enableAudioBtn").addEventListener("click", () => {
        pixelStream.enableCharacterAudio().catch(console.error);
      });

      document.getElementById("disableAudioBtn").addEventListener("click", () => {
        pixelStream.disableCharacterAudio().catch(console.error);
      });

      // Optional: re-run sizing after the experience initializes (some embeds change layout)
      // This helps if the convai player injects elements that affect measured heights.
      const originalInit = pixelStream.initializeExperience.bind(pixelStream);
      pixelStream.initializeExperience = async () => {
        const result = await originalInit();
        setTimeout(resizeStream, 50);
        setTimeout(resizeStream, 250);
        return result;
      };
    </script>
  </body>
</html>
